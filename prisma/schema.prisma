// ============================
// Prisma Schema Unificado (Web + Expo)
// ============================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================
// MODELOS DE DOMÍNIO
// ============================

model Usuario {
  id       String      @id @default(uuid())
  nome     String      @db.VarChar(30)
  email    String      @unique @db.VarChar(60)
  senha    String      @db.VarChar(72)
  tipo     TipoUsuario

  // campos opcionais para perfil
  telefone String?     @db.VarChar(20)
  fotoUrl  String?     @db.VarChar(255)

  cliente      Cliente?
  proprietario Proprietario?
  admin        Admin?

  notificacoes Notificacao[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum TipoUsuario {
  CLIENTE
  PROPRIETARIO
  ADMIN
}

model Cliente {
  id        String  @id @default(uuid())
  usuarioId String  @unique
  usuario   Usuario @relation(fields: [usuarioId], references: [id])

  reservas   Reserva[]
  avaliacoes Avaliacao[]
  enderecos  Endereco[]
}

model Proprietario {
  id               String            @id @default(uuid())
  usuarioId        String            @unique
  usuario          Usuario           @relation(fields: [usuarioId], references: [id])
  nivel_privilegio Niveis_privilegio @default(PLANO_BASICO)

  lavanderias Lavanderia[]
  relatorios  Relatorio[]
}

model Admin {
  id        String  @id @default(uuid())
  usuarioId String  @unique
  usuario   Usuario @relation(fields: [usuarioId], references: [id])

  // opcional: nível interno de acesso no painel web
  nivel Int @db.SmallInt @default(2)

  relatorios  Relatorio[]
  maquinas    Maquina[]     // máquinas criadas/alteradas por este admin
  logs        Log[]
  lavanderias Lavanderia[]  @relation("AdminLavanderias")
}

model Lavanderia {
  id                String       @id @default(uuid())
  nomeFantasia      String       @db.VarChar(60)
  razaoSocial       String       @db.VarChar(100)
  endereco          String       @db.VarChar(255)
  telefone          String?      @db.VarChar(20)
  horarioAbertura   String?      @db.VarChar(10)
  horarioFechamento String?      @db.VarChar(10)
  descricao         String?      @db.VarChar(255)
  fotoUrl           String?      @db.VarChar(255)
  latitude          Float?
  longitude         Float?

  proprietario    Proprietario @relation(fields: [proprietario_id], references: [id])
  proprietario_id String

  // campos herdados do schema Web antigo
  qntMaquinas Int     @default(0)
  destaque    Boolean @default(true)

  maquinas   Maquina[]
  avaliacoes Avaliacao[]

  admins Admin[] @relation("AdminLavanderias")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([latitude, longitude])
}

model Maquina {
  id             String         @id @default(uuid())
  tipo           Tipo_maquina   @default(LAVADORA)
  status_maquina Status_maquina @default(DISPONIVEL)
  capacidade     Int            @default(4)
  preco          Decimal        @db.Decimal(10, 2)

  // compatível com a API antiga (web)
  ativa Boolean @default(true)

  lavanderia    Lavanderia @relation(fields: [lavanderia_id], references: [id])
  lavanderia_id String

  reservas Reserva[]

  // opcional: qual admin criou/alterou esta máquina
  admin   Admin? @relation(fields: [adminId], references: [id])
  adminId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Relatorio {
  id              String       @id @default(uuid())
  admin           Admin        @relation(fields: [admin_id], references: [id])
  admin_id        String
  proprietario    Proprietario @relation(fields: [proprietario_id], references: [id])
  proprietario_id String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Reserva {
  id     String         @id @default(uuid())
  status Status_reserva @default(EM_ANDAMENTO)

  cliente    Cliente @relation(fields: [cliente_id], references: [id])
  cliente_id String

  maquina    Maquina @relation(fields: [maquina_id], references: [id])
  maquina_id String

  // janela da reserva
  inicio DateTime
  fim    DateTime

  pagamento Pagamento?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // evita duplicidade e otimiza consultas
  @@unique([maquina_id, inicio])
  @@index([cliente_id, inicio])
  @@index([maquina_id, inicio])
  @@index([status, inicio])
}

model Avaliacao {
  id            String     @id @default(uuid())
  nota          Int
  comentario    String     @db.VarChar(255)
  cliente       Cliente    @relation(fields: [cliente_id], references: [id])
  cliente_id    String
  lavanderia    Lavanderia @relation(fields: [lavanderia_id], references: [id])
  lavanderia_id String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Pagamento {
  id       String           @id @default(uuid())
  valor    Decimal          @db.Decimal(10, 2)
  metodo   Metodo_Pagamento @default(PIX)
  status   Status_Pagamento @default(PENDENTE)

  reserva   Reserva @relation(fields: [reservaId], references: [id])
  reservaId String  @unique

  createdAt DateTime @default(now())
}

model Notificacao {
  id        String          @id @default(uuid())
  titulo    String          @db.VarChar(100)
  mensagem  String          @db.VarChar(255)
  tipo      TipoNotificacao @default(SISTEMA)
  lida      Boolean         @default(false)

  usuarioId String
  usuario   Usuario         @relation(fields: [usuarioId], references: [id])

  createdAt DateTime @default(now())
}

model Endereco {
  id        String   @id @default(uuid())
  apelido   String   @db.VarChar(30)
  rua       String   @db.VarChar(100)
  bairro    String   @db.VarChar(60)
  cidade    String   @db.VarChar(60)
  estado    String   @db.VarChar(2)
  cep       String?  @db.VarChar(9)
  latitude  Float?
  longitude Float?

  clienteId String
  cliente   Cliente @relation(fields: [clienteId], references: [id])
}

// LOG vindo do schema Web original
model Log {
  id          Int      @id @default(autoincrement())
  admin       Admin    @relation(fields: [adminId], references: [id])
  adminId     String
  descricao   String   @db.VarChar(60)
  complemento String   @db.VarChar(200)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ============================
// ENUMS
// ============================

enum Status_reserva {
  FEITA
  EM_ANDAMENTO
  CANCELADA
}

enum Status_maquina {
  DISPONIVEL
  EM_USO
  EM_MANUTENCAO
}

enum Tipo_maquina {
  LAVADORA
  SECADORA
}

enum Niveis_privilegio {
  PLANO_BASICO
  PLANO_PREMIUM
}

enum Metodo_Pagamento {
  PIX
}

enum Status_Pagamento {
  FEITO
  PENDENTE
  CANCELADO
}

enum TipoNotificacao {
  SISTEMA
  PROMOCAO
  ALERTA
}
